name: Build SSAO Niat

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Shallow clone for speed

    - name: ğŸ”§ Setup Android NDK (r24)
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r24
        local-cache: true

    - name: ğŸ’¾ Cache AML Dependencies
      id: cache-aml
      uses: actions/cache@v3
      with:
        path: |
          AML_PrecompiledLibs
          include
          ARMPatch
        key: ${{ runner.os }}-aml-deps-${{ hashFiles('setup.sh') }}
        restore-keys: |
          ${{ runner.os }}-aml-deps-

    - name: ğŸ“¥ Download AML Dependencies
      if: steps.cache-aml.outputs.cache-hit != 'true'
      run: |
        chmod +x setup.sh
        ./setup.sh || echo "Setup script not found, continuing..."

    - name: ğŸ”¨ Build ARMPatch
      run: |
        if [ -d "ARMPatch/armpatch_src" ]; then
          echo "Building ARMPatch..."
          ndk-build NDK_PROJECT_PATH=. \
                    APP_BUILD_SCRIPT=./ARMPatch/armpatch_src/Android.mk \
                    NDK_APPLICATION_MK=./ARMPatch/armpatch_src/Application.mk \
                    NDK_DEBUG=0 \
                    -j$(nproc) || echo "ARMPatch build failed, continuing..."
        else
          echo "ARMPatch not found, skipping..."
        fi

    - name: ğŸš€ Build SSAO Niat Mod
      run: |
        echo "Building SSAO Niat..."
        ndk-build NDK_PROJECT_PATH=. \
                  APP_BUILD_SCRIPT=./jni/Android.mk \
                  NDK_APPLICATION_MK=./jni/Application.mk \
                  NDK_DEBUG=0 \
                  V=1 \
                  -j$(nproc)

    - name: ğŸ“‹ List Build Output
      run: |
        echo "Build artifacts:"
        ls -lh libs/armeabi-v7a/ || echo "No build output found!"

    - name: ğŸ“¦ Prepare Release Package
      run: |
        mkdir -p release
        
        # Copy built library
        cp libs/armeabi-v7a/libSSAO_Niat.so release/
        
        # Create installation instructions
        cat > release/INSTALL.txt << 'EOF'
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          SSAO Niat - Installation Guide
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        1. Copy libSSAO_Niat.so to:
           /sdcard/Android/data/com.rockstargames.gtasa/mods/

        2. Launch GTA San Andreas

        3. Check if mod loaded:
           adb logcat | grep SSAO_Niat

        Expected output:
           SSAO_Niat: Mod loaded successfully!
           SSAO_Niat: RenderScene hooked!
           SSAO_Niat: SSAO system initialized!

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        Build Info:
        - Commit: ${{ github.sha }}
        - Date: $(date)
        - Branch: ${{ github.ref_name }}
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EOF
        
        # Copy README
        cp README.md release/ || echo "README not found"

    - name: ğŸ“¤ Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SSAO_Niat_Mod_${{ github.sha }}
        path: release/*
        retention-days: 90
        if-no-files-found: error

    - name: ğŸ“Š Build Summary
      run: |
        echo "## ğŸ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- libSSAO_Niat.so" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
        echo "Check the 'Artifacts' section below" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â„¹ï¸ Build Info:" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- NDK: r24" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ·ï¸ Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Build status notification
  notify:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: ğŸ“¢ Build Status
      run: |
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… Build succeeded!"
        else
          echo "âŒ Build failed!"
          exit 1
        fi
